devtools::install_github("jacobkap/asciisetupreader")
library(asciiSetupReader)
library(dplyr)
library(stringr)
library(data.table)
library(memisc)
library(haven)
library(readr)
options(warn = 2)

# utils for UCR files

save_files <- function(data, year, file_name, save_name, rda_only = FALSE) {
  assign(paste0(file_name, year), data) # Change name
  save( list = paste0(file_name, year),
        file = paste0(save_name, year, ".rda"))


  if (rda_only == FALSE) {
  Write(codebook(data),
       file = paste0(file_name, "codebook_", year, ".txt"))

  do.call("write_dta", list(as.name(paste0(file_name, year)),
                            path = paste0(save_name,
                                          year, ".dta")))
  do.call("write_csv", list(as.name(paste0(file_name, year)),
                            path = paste0(save_name,
                                          year, ".csv")))
  do.call("write_sav", list(as.name(paste0(file_name, year)),
                            path = paste0(save_name,
                                          year, ".sav")))
  do.call("rm", list(as.name(paste0(file_name, year))))
  }
}

save_as_zip <- function(file_name) {
  file_ext <- c("rda", "dta", "csv", "sav")
  all_files <- list.files()
  codebooks <- all_files[grep("codebook", all_files)]
  for (i in seq_along(file_ext)) {
    zip_files <- all_files[grep(file_ext[i], all_files)]
    zip_files <- c(zip_files, codebooks)

    zip::zip(zipfile = paste0(file_name,
                              file_ext[i], ".zip"),
             files = zip_files)
  }
}

save_raw_as_zip <- function(file_name) {
  all_files <- list.files()
  zip::zip(zipfile = paste0(file_name, ".zip"),
           files = all_files)
}

make_state_abb <- function(state) {
  state_abb <- state.abb[match(tolower(state), tolower(state.name))]
  state_abb[tolower(state) == "canal zone"]           <- "CZ"
  state_abb[tolower(state) == "district of columbia"] <- "DC"
  state_abb[tolower(state) == "guam"]                 <- "GU"
  state_abb[tolower(state) == "puerto rico"]          <- "PR"
  return(state_abb)
}


years <- years <- c("^76$"         = "1976",
                    "^99$"         = "1999",
                    "^16$"         = "2016",
                    "^79$"         = "1979",
                    "NOT REPORTED" = NA,
                    "^75$"         = "1975",
                    "^79$"         = "1979",
                    "^80$"         = "1980",
                    "^81$"         = "1981",
                    "^82$"         = "1982")

states <- c("washington, d.c"    = "district of columbia",
            "washington, d"      = "district of columbia",
            "dist of columbia"   = "district of columbia",
            "55"                 = "guam",
            "54"                 = "american samoa",
            "53"                 = "puerto rico",
            "52"                 = "canal zone",
            "99"                 = NA,
            "not reported"       = NA,
            "62"                 = "virgin islands")

division <- c("e. south central"            = "east south central",
              "east st south ceast tral"    = "east south central",
              "west ast t south ceast tral" = "west south central,",
              "east st north central"       = "east north central",
              "west ast t north central"    = "west north central",
              "east st north ceast tral"    = "east north central",
              "west ast t north ceast tral" = "west north central",
              "w. south central"            = "west south central",
              "e. north central"            = "east north central",
              "east st north central"       = "east north central",
              "w. north central"            = "west north central",
              "east st south central"       = "east south central",
              "west ast t south central"    = "west south central",
              "east north ceast tral"       = "east north central",
              "west nceast "                = "west north central",
              "neast  east land"            = "west north central",
              "u. s. posseast sion"         = "possessions",
              "u.s. possessions"            = "possessions",
              "u. s. posessions"            = "possessions",
              " states"                     = "",
              "eng1and"                     = "england",
              "al,ky,ms,tn"                 = "east south central",
              "az,co,id,mt,nv,n"            = "mountain",
              "ar,la,ok, texas"             = "west south central",
              "ak,ca,hi,or,wa"              = "pacific",
              "ct,me,ma,nh"                 = "new england",
              "de,fl,ga,md,nort"            = "south atlantic",
              "il,in,mi,oh,wi"              = "east north central",
              "ia,ks,mn,mo,ne,n"            = "west north central",
              "nj ny pa"                    = "mid-atlantic",
              "w ncen states"               = "west north central",
              "s atlantic sts"              = "south atlantic",
              "^0%"                         = "possessions",
              "^1$"                         = "new england",
              "^2$"                         = "mid-atlantic",
              "^3$"                         = "east north central",
              "^4$"                         = "west north central",
              "^5$"                         = "south atlantic",
              "^6$"                         = "east south central",
              "^7$"                         = "west south central",
              "^8$"                         = "mountain",
              "^9$"                         = "pacific",
              "alabama, kentucky, mississippi, tennessee"          = "east south central",
              "arizona, colorado, idaho, montana, nevada, new"     = "mountain",
              "arkansas, louisiana, oklahoma, texas"               = "west south central",
              "alaska, california, hawaii, oregon, washington"     = "pacific",
              "connecticut, maine, massachusetts, new hampshire,"  = "new enland",
              "delaware, florida, georgia, maryland, north"        = "south atlantic",
              "illinois, indiana, michigan, ohio, wisconsin"       = "east north central",
              "iowa, kansas, minnesota, missouri, nebraska, north" ="west north central",
              "new jersey, new york, pennsylvania"                 = "mid-atlantic",
              "midd1east atlantic"          = "mid-atlantic",
              "midast atlantic"             = "mid-atlantic",
              "^u$"                         = NA,
              "^0$"                         = NA,
              "e\\."                        = "east ",
              "w\\."                        = "west ",
              "cntrl"                       = "central",
              "middle"                      = "mid",
              "east st south ceast tral"    = "east south central",
              "west ast t south ceast tral" = "west south central",
              "posseast sions"              = "possessions",
              "west nceast "                = "west north central",
              "east st north ceast tral"    = "east north central",
              "new enland"                  = "new england",
              "w ncen"                      = "west north central",
              "midd1e atlantic"             = "mid-atlantic",
              "mid "                        = "mid-",
              "u. s. possession"            = "possessions",
              ":.*"                         = "",
              "^e s.cent$"                  = "east south central",
              "^w s.cent$"                  = "west south central",
              "^new englnd sts$"            = "new england",
              "^sth atl$"                   = "south atlantic",
              "^e n.cent$"                  = "east north central",
              "^w n.cent$"                  = "west north central",
              "^mid-atl$"                   = "mid-atlantic",
              "^est sth cntl sttes$"        = "east south central",
              "^wst sth cntl sttes$"        = "west south central",
              "^new englnd sttes$"          = "new england",
              "^sth atlntc$"                = "south atlantic",
              "^est nth cntl sttes$"        = "east north central",
              "^wst nth cntl sttes$"        = "west north central",
              "^mddle atltc sttes$"         = "mid-atlantic")

group_number_fix <- c("^msa cts 100000/over$"   = "msa county 100,000+",
                  "^cts 25000-49999$"       = "city 25,000 thru 49,999",
                  "^cts 250000-499999$"     = "city 250,000 thru 499,999",
                  "^cts 10000-24999$"       = "city 10,000 thru 25,000",
                  "^cits 2500-9999$"        = "city 2,500 thru 9,999",
                  "^cts undr 2,500$"        = "city under 2,500",
                  "^cts 100000-249999$"     = "city 100,000 thru 249,999",
                  "^msa cts 10000-24999$"   = "msa county 10,000 thru 24,999",
                  "^n-ms cts udr 10,000$"   = "non-msa county under 10,000",
                  "^msa cts 25000-99999$"   = "msa county 25,000 thru 99,999",
                  "^n-ms cts 10000-24999$"  = "msa county 10,000 thru 24,999",
                  "^n-ms cts 25000-99999$"  = "msa county 25,000 thru 99,999",
                  "^cts 50000-99999$"       = "city 50,000 thru 99,999",
                  "^al cts mlln ovr$"       = "city 1,000,000+",
                  "^cts 500000-999999$"     = "city 500,000 thru 999,999",
                  "^ms cts udr 10000$"      = "msa county under 10,000",
                  "^n-msa cots 10000$"      = "non-msa county 10,000 thru 24,999",
                  "^all cities 1,000,000 or over$" = "city 1,000,000+",
                  "^cit < 2,500$"             = "city under 2,500",
                  "^cit 1,000,000 \\+$"       = "city 1,000,000+",
                  "^cit 10,000-24,999$"       = "city 10,000 thru 24,999",
                  "^cit 100,000-249,999$"     = "city 100,000 thru 249,999",
                  "^cit 2,500-9,999$"         = "city 2,500 thru 9,999",
                  "^cit 25,000-49,999$"       = "city 25,000 thru 49,999",
                  "^cit 250,000-499,999$"     = "city 250,000 thru 499,999",
                  "^cit 50,000-99,999$"       = "city 50,000 thru 99,999",
                  "^cit 500,000-999,999$"     = "city 500,000 thru 999,999",
                  "^cit bt 100k-250k$"        = "city 100,000 thru 249,999",
                  "^cit bt 2.5k-9.9k$"        = "city 2,500 thru 9,999",
                  "^citi bet 10l-25k$"        = "city 10,000 thru 24,999",
                  "^citi bet 50K-99k$"        = "city 50,000 thru 99,999",
                  "^citie bet 10-24k$"        = "city 10,000 thru 24,999",
                  "^citie bet 25-49k$"        = "city 25,000 thru 49,999",
                  "^citie bet 50-99k$"        = "city 50,000 thru 99,999",
                  "^cities 10,000 thru 24,999$"   = "city 10,000 thru 25,000",
                  "^cities 100,000 thru 249,999$" = "city 100,000 thru 249,999",
                  "^cities 2,500 thru 9,999$"     = "city 2,500 thru 9,999",
                  "^cities 25,000 thru 49,999$"   = "city 25,000 thru 49,999",
                  "^cities 250,000 thru 499,999$" = "city 250,000 thru 499,999",
                  "^cities 50,000 thru 99,999$"   = "city 50,000 thru 99,999",
                  "^cities 500,000 thru 999,999$" = "city 500,000 thru 999,999",
                  "^cities under 2,500$"     = "city under 2,500",
                  "^cits bet 25k-50k$"       = "city 25,000 thru 49,999",
                  "^msa co. < 10,000$"       = "msa county under 10,000",
                  "^msa co. 10,000-24,999$"  = "msa county 10,000 thru 24,999",
                  "^msa co. 100,000 \\+$"    = "msa county 100,000+",
                  "^msa co. 25,000-99,999$"  = "msa county 25,000 thru 99,999",
                  "^msa counties$"           = "msa county",
                  "^msa counties 10,000 thru 24,999$" = "msa county 10,000 thru 24,999",
                  "^msa counties 100,000 or over$"    = "msa county 100,000+",
                  "^msa counties 25,000 thru 99,999$" = "msa county 25,000 thru 99,999",
                  "^msa counties under 10,000$"       = "msa county under 10,000",
                  "^msa st Police$"                   = "msa state police",
                  "^non-msa CNTIES$"                  = "non-msa county",
                  "^non-msa co. < 10,000$"            = "non-msa county under 10,000",
                  "^non-msa co. 10,000-24,999$"       = "non-msa county 10,000 thru 24,999",
                  "^non-msa co. 100,000 \\+$"         = "non-msa county 100,000+",
                  "^non-msa co. 25,000-99,999$"       = "non-msa county 25,000 thru 99,999",
                  "^non-msa counties 10,000 thru 24,999$" = "non-msa county 10,000 thru 24,999",
                  "^non-msa counties 100,000 or over$"    = "non-msa county 100,000+",
                  "^non-msa counties 25,000 thru 99,999$" = "non-msa county 25,000 thru 99,999",
                  "^non-msa counties under 10,000$"       = "non-msa county under 10,000",
                  "^non-msa st Police$"    = "non-msa state police",
                  "^non-smsa counties$"    = "non-msa county",
                  "^smsa counties$"        = "msa county",

                  "^8d$" = "non-msa county under 10,000",
                  "^9a$" = "msa county 100,000+",
                  "^4$"  = "city 25,000 thru 49,999",
                  "^1c$" = "city 250,000 thru 499,999",
                  "^5$"  = "city 10,000 thru 24,999",
                  "^6$"  = "city 2,500 thru 9,999",
                  "^7$"  = "city under 2,500",
                  "^2$"  = "city 100,000 thru 249,999",
                  "^9c$" = "msa county 10,000 thru 24,999",
                  "^9d$" = "msa county under 10,000",
                  "^9b$" = "msa county 25,000 thru 99,999",
                  "^8c$" = "non-msa county 10,000 thru 24,999",
                  "^8b$" = "non-msa county 25,000 thru 99,999",
                  "^3$"  = "city 50,000 thru 99,999",
                  "^1a$" = "city 1,000,000+",
                  "^1b$" = "city 500,000 thru 999,999",
                  "^9e$" = "msa state police",
                  "^8e$" = "non-msa state police",
                  "^8a$" = "non-msa county 100,000+",

                  # LEOKA groups
                  "^non-smsa cnties$"   = "non-msa county",
                  "^cities < 2,500$"    = "city under 2,500",
                  "^smsa counties$"     = "msa county",
                  "^cities 25k-49.9k$"  = "city 25,000 thru 49,999",
                  "^all cities 250k\\+$" = "city 250,000+",
                  "^cities 10k-24.9k$"  = "city 10,000 thru 24,999",
                  "^cities 2.5k-9.9k$"  = "city 2,500 thru 9,999",
                  "^cities 100k-249k$"  = "city 100,000 thru 249,999",
                  "^cities 50k-99.9k$"  = "city 50,000 thru 99,999",
                  "^0$"                 = "possessions",
                  "^non-msa counties under 10,000$" = "non-msa county under 10,000",
                  "^cities under 2,500$"            = "city under 2,500",
                  "^msa counties 100,000 or over$"  = "msa counties 100,000+",
                  "^cities from 25,000-49,999$"     = "city 25,000 thru 49,999",
                  "^cities from 250,000-499,999$"   = "city 250,000 thru 499,999",
                  "^cities from 10,000-24,999$"     = "city 10,000 thru 24,999",
                  "^cities from 2,500-9,999$"       = "city 2,500 thru 9,999",
                  "^msa counties from 25,000-99,999$"  = "msa county 25,000 thru 99,999",
                  "^cities from 100,000-249,000$"      = "city 100,000 thru 249,999",
                  "^msa counties from 10,000-24,999$"  = "city 10,000 thru 24,999",
                  "^non-msa counties from 10,000-24,999$"  = "non-msa county 10,000 thru 24,999",
                  "^non-msa counties from 25,000-99,999$"  = "non-msa county 25,000 thru 99,999",
                  "^cities from 50,000-99,999$"    = "city 50,000 thru 99,999",
                  "^cities from 500,000-999,999$"  = "city 500,000 thru 999,999",
                  "^msa counties under 10,000$"    = "msa county under 10,000",
                  "^cities 1,000,000 or over$"     = "city 1,000,000+",
                  "^non-msa counties 100,000 or over$"  = "non-msa county 100,000+",
                  "^non-smsa countie$"  = "non-msa county",
                  "^citie under 2.5k$"  = "city under 2,500",
                  "^citie bet 25-49k$"  = "city 25,000 thru 49,999",
                  "^cit bet 10-24.9k$"  = "city 10,000 thru 24,999",
                  "^cit bet 2.5-9.9k$"  = "city 2,500 thru 9,999",
                  "^cit bet 100-249k$"  = "city 100,000 thru 249,999",
                  "^citie bet 50-99k$"  = "city 50,000 thru 99,999",
                  "^cit bet 25-49.9k$"  = "city 25,000 thru 49,999",
                  "^all citie 250k\\+$" = "city 250,000+",
                  "^cit bet 50-99.9k$"  = "city 50,000 thru 99,999",
                  "^non-msa counties$"  = "non-msa county",
                  "^msa counties$"      = "msa county",
                  "^cities 25-50$"      = "city 25,000 thru 49,999",
                  "^all cities 250\\+$" = "city 250,000+",
                  "^cities 10-25$"      = "city 10,000 thru 24,999",
                  "^cities 2.5-10$"     = "city 2,500 thru 9,999",
                  "^cities under 2.5$"  = "city under 2,500",
                  "^cities 100-250$"    = "city 100,000 thru 249,999",
                  "^cities 50-100$"     = "city 50,000 thru 99,999",
                  "^cities between 25,000 and 49,999$"   = "city 25,000 thru 49,999",
                  "^all cities 250,000 or over$"         = "city 250,000+",
                  "^cities between 10,000 and 24,999$"   = "city 10,000 thru 24,999",
                  "^cities between 2,500 and 9,999$"     = "city 2,500 thru 9,999",
                  "^cities between 100,000 and 249,999$" = "city 100,000 thru 249,999",
                  "^cities between 50,000 and 99,999$"   = "city 50,000 thru 99,999",
                  "^cities from 250,000 through 499,999$"   = "city 250,000 thru 499,999",
                  "^cities from 500,000 through 999,999$"   = "city 500,000 thru 999,999",
                  "^possessions.*"      = "possessions",
                  "^msa counties 100,000\\+$" = "msa county 100,000+",
                  "^7b$" = NA,
                  "^non-msa counties 100,000\\+$" = "non-msa county 100,000+",
                  " through " = " thru "
                  )

sub_group <- c("^smsa 100k\\+$"     = "msa county 100,000+",
               "^citie bet 25-49k$" = "city 25,000 thru 49,999",
               "^cit bet 250-499k$" = "city 250,000 thru 499,999",
               "^citie bet 10-24k$" = "city 10,000 thru 24,999",
               "^cit bet 2.5-9.9k$" = "city 2,500 thru 9,999",
               "^smsa 25-99k$"      = "msa county 25,000 thru 99,999",
               "^cit bet 100-249k$" = "city 100,000 thru 249,999",
               "^smsa 10-24.9k$"    = "msa county 10,000 thru 24,999",
               "^non-smsa 10-24k$"  = "non-msa county 10,000 thru 24,999",
               "^non-smsa <10k$"    = "non-msa county under 10,000",
               "^non-smsa 25-99k$"  = "non-msa county 25,000 thru 99,999",
               "^citie under 2.5k$" = "city under 2,500",
               "^citie bet 50-99k$" = "city 50,000 thru 99,999",
               "^cit bet 500-999k$" = "city 500,000 thru 999,999",
               "^all cities 1m\\+$" = "city 1,000,000+",
               "^non-smsa 100k\\+$" = "non-msa county 100,000+",
               "^smsa count <10k$"  = "msa county under 10,000",
               "^95$"               = NA,
               "^85$"               = NA,
               "^msa 100k\\+$"      = "msa county 100,000+",
               "^citie bt 25k-50k$" = "city 25,000 thru 49,999",
               "^cit bet 250-500k$" = "city 250,000 thru 499,999",
               "^cit bet 2.5k-10k$" = "city 2,500 thru 9,999",
               "^citie bt 10k-25k$" = "city 10,000 thru 24,999",
               "^cit bt 100k-250k$" = "city 100,000 thru 249,999",
               "^msa 10k-25k$"      = "msa county 10,000 thru 24,999",
               "^msa 25k-100k$"     = "msa county 25,000 thru 99,999",
               "^non-msa 10k-25k$"  = "non-msa county 10,000 thru 24,999",
               "^non-msa <10k$"     = "non-msa county under 10,000",
               "^non-msa 25k-100k$" = "non-msa county 25,000 thru 99,999",
               "^citi bt 50k-100k$" = "city 50,000 thru 99,999",
               "^cit bt 500k-999k$" = "city 500,000 thru 999,999",
               "^msa count <10k$"   = "msa county under 10,000",
               "^non-msa 100k\\+$"  = "non-msa county 100,000+",


               # LEOKA
               "^non-smsa < 10k$"        = "non-msa county under 10,000",
               "^smsa 1oo,000\\+$"       = "msa county 100,000+",
               "^cities 250k-499k$"      = "city 250,000 thru 499,999",
               "^smsa 25k-99k$"          = "msa county 25,000 thru 99,999",
               "^smsa 1ok-24.9k$"        = "msa county 10,000 thru 24,999",
               "^non-smsa 10k-25k$"      = "non-msa county 10,000 thru 24,999",
               "^non-smsa 25k-99k$"      = "non-msa county 25,000 thru 99,999",
               "^cities 50k-99k$"        = "city 50,000 thru 99,999",
               "^cities 500k-999k$"      = "city 500,000 thru 999,999",
               "^smsa < 10,000$"         = "msa county under 10,000",
               "^all cities 1mil\\+$"    = "city 1,000,000+",
               "^non-msa county 100,000\\+$" = "non-msa county 100,000+",
               "^smsa state police$"     = "msa state police",
               "^possess- guam...$"      = "possessions",
               "^non-msa county under 10,000$" = "non-msa county under 10,000",
               "^smsa 25-99.9k$"         = "msa county 25,000 thru 99,999",
               "^cit bet 50-99k$"        = "city 50,000 thru 99,999",
               "^smsa under 10k$"        = "msa county under 10,000",
               "^possess guam etc$"      = "possessions",
               "^smsa count 10k\\+$"     = "msa county 100,00+",
               "^non-msa under 10$"      = "non-msa county under 10,000",
               "^msa 100\\+$"            = "msa county 100,000+",
               "^cities 250-500$"        = "city 250,000 thru 499,999",
               "^msa 10-25$"             = "msa county 10,000 thru 24,999",
               "^msa under 10$"          = "msa county under 10,000",
               "^msa 25-100$"            = "city 250,000 thru 499,999",
               "^non-msa 10-25$"         = "non-msa county 10,000 thru 24,999",
               "^non-msa 25-100$"        = "non-msa county 25,000 thru 99,999",
               "^cities 500-1000$"       = "city 500,000 thru 999,999",
               "^all cities 1000\\+$"    = "city 1,000,000+",
               "^non-msa st polic$"      = "non-msa state police",
               "^non-msa 100\\+$"        = "non-msa county 100,000+",
               "^cities between 250,000 and 499,999$"     = "city 250,000 thru 499,999",
               "^msa counties between 10,000 and 24,999$" = "msa county 10,000 thru 24,999",
               "^msa counties between 25,000 and 99,999$" = "msa county 25,000 thru 99,999",
               "^non-msa counties between 10,000 and 24$" = "non-msa county 10,000 thru 24,999",
               "^non-msa counties between 25,000 and 99$" = "non-msa county 25,000 thru 99,999",
               "^cities between 500,000 and 999,999$"     = "city 500,000 thru 999,999",
               "non-smsa state police"                    = "non-msa state police"
               )


